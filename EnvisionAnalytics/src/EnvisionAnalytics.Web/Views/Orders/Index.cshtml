@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h3>Orders</h3>
<form id="filters" class="row g-2 mb-3">
    <div class="col-auto"><input class="form-control" type="date" name="start" /></div>
    <div class="col-auto"><input class="form-control" type="date" name="end" /></div>
    <div class="col-auto"><select name="status" class="form-select"><option value="">Any</option><option>Completed</option><option>Cancelled</option></select></div>
    <div class="col-auto"><input class="form-control" type="number" step="0.01" name="minAmount" placeholder="Min Amount" /></div>
    <div class="col-auto"><select id="pageSize" class="form-select" style="width:120px"><option value="10">10</option><option value="25" selected>25</option><option value="50">50</option></select></div>
    <div class="col-auto"><button class="btn btn-primary" id="btnFilter">Filtrar</button></div>
    <div class="col-auto"><a id="export" class="btn btn-outline-secondary">Export CSV</a></div>
</form>

<div id="table" class="table-responsive"></div>
<nav><ul id="pagination" class="pagination"></ul></nav>

@section Scripts {
<script>
let currentSortBy = 'OrderDate';
let currentSortDir = 'desc';

async function load(page=1){
    const f = new FormData(document.getElementById('filters'));
    const params = new URLSearchParams();
    for (const pair of f.entries()) if (pair[1]) params.append(pair[0], pair[1]);
    params.append('page', page);
    const ps = document.getElementById('pageSize').value || '25';
    params.append('pageSize', ps);
    params.append('sortBy', currentSortBy);
    params.append('sortDir', currentSortDir);

    document.getElementById('table').innerHTML = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    const resp = await fetch('/Orders/List?'+params.toString());
    const j = await resp.json();
    const rows = j.items.map(o=> `<tr><td>${new Date(o.orderDate).toLocaleString()}</td><td>${o.customer?.name||''}</td><td>${o.status}</td><td>${o.totalAmount}</td></tr>`).join('');
    document.getElementById('table').innerHTML = `<table class='table'><thead><tr><th><a href='#' data-sort='OrderDate'>Date</a></th><th><a href='#' data-sort='Customer'>Customer</a></th><th>Status</th><th><a href='#' data-sort='TotalAmount'>Total</a></th></tr></thead><tbody>${rows}</tbody></table>`;

    // pagination
    const total = j.total;
    const pageSize = Number(document.getElementById('pageSize').value || 25);
    const pages = Math.ceil(total / pageSize) || 1;
    const pag = document.getElementById('pagination');
    pag.innerHTML = '';
    for(let p=1;p<=pages;p++){ pag.innerHTML += `<li class='page-item ${p===page? 'active':''}'><a class='page-link' href='#' data-page='${p}'>${p}</a></li>` }
    pag.querySelectorAll('a[data-page]').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); load(Number(a.dataset.page)); }));

    document.querySelectorAll('a[data-sort]').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); const s = a.dataset.sort; if (currentSortBy===s) currentSortDir = currentSortDir==='asc'?'desc':'asc'; else { currentSortBy = s; currentSortDir='asc'; } load(1); }));
}

document.getElementById('btnFilter').addEventListener('click', e=>{ e.preventDefault(); load(); });
document.getElementById('export').addEventListener('click', ()=>{
    const f = new FormData(document.getElementById('filters'));
    const params = new URLSearchParams();
    for (const pair of f.entries()) if (pair[1]) params.append(pair[0], pair[1]);
    window.location = '/Orders/ExportCsv?'+params.toString();
});

load();
</script>
}
